<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“ˆ æœˆé–“çµ±è¨ˆ</title>
  <meta name="robots" content="noindex, nofollow">
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #f6f7fb; --fg: #1f2937; --card: #ffffff; --grad1:#667eea; --grad2:#764ba2; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'M PLUS Rounded 1c', system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--fg); }
    .wrap{ max-width:900px; margin:0 auto; padding:20px; }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    h1{ margin:0; font-size:clamp(1.6rem,4vw,2.2rem); }
    a.btn, button.btn{ display:inline-block; padding:10px 16px; border-radius:12px; border:none; text-decoration:none; font-weight:700; cursor:pointer; }
    .btn-primary{ background:linear-gradient(135deg,var(--grad1),var(--grad2)); color:#fff; box-shadow:0 6px 18px rgba(118,75,162,0.25); }
    .card{ background:var(--card); border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.08); padding:18px; margin-top:16px; }
    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; }
    .stat-card{ border-radius:14px; padding:20px; text-align:center; background:linear-gradient(135deg,#ffffff,#f4f5fb); }
    .stat-number{ font-size:2rem; font-weight:800; margin-bottom:6px; }
    .stat-label{ opacity:.75; }
    .note{ font-size:.9rem; opacity:.75; margin-top:10px; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn-secondary{ background:#eef2ff; color:#3730a3; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“ˆ æœˆé–“çµ±è¨ˆ</h1>
      <div class="controls">
        <a class="btn btn-secondary" href="./index.html">â† æˆ»ã‚‹</a>
      </div>
    </header>

    <!-- æœˆé–“çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="card" aria-labelledby="monthly-stats-title">
      <h2 id="monthly-stats-title" style="margin:0 0 8px">ä»Šæœˆã®ã‚µãƒãƒªãƒ¼</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="monthlyTakenCount">0</div>
          <div class="stat-label">ä»Šæœˆã®æœè–¬å›æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="monthlyTotalCount">0</div>
          <div class="stat-label">ä»Šæœˆã®ç·æœè–¬å›æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="monthlyStreakCount">0</div>
          <div class="stat-label" id="streakLabel">ä»Šæœˆã®æœ€é•·é€£ç¶šæ—¥æ•°</div>
        </div>
      </div>
      <p class="note" id="rangeNote"></p>
    </section>
  </div>

  <script>
    // ====== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆãƒ¡ã‚¤ãƒ³ã¨åŒã˜ä»•æ§˜ã§OKï¼‰ ======
    const medicationTimes = ['æœ','æ˜¼','æ™©']; // æ—¢å®šã®æ™‚é–“å¸¯

    function formatDate(date){
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function formatJapaneseDate(date){
      return `${date.getFullYear()}å¹´${date.getMonth()+1}æœˆ${date.getDate()}æ—¥`;
    }
    function loadData(dateStr){
      try{
        const json = localStorage.getItem(`medication-${dateStr}`);
        return json ? JSON.parse(json) : { times:{}, custom:[] };
      }catch(e){
        return { times:{}, custom:[] };
      }
    }

    // ====== æœˆé–“çµ±è¨ˆ ======
    const currentDate = new Date(); // è¡¨ç¤ºã—ãŸã„æœˆã¯ã“ã“ã‚’åŸºæº–ã«ã™ã‚‹ï¼ˆä»Šæœˆï¼‰

    function updateMonthlyStatistics() {
      const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const monthEnd   = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0);

      document.getElementById('rangeNote').textContent =
        `å¯¾è±¡æœŸé–“ï¼š${formatJapaneseDate(monthStart)} ã€œ ${formatJapaneseDate(monthEnd)}`;

      let monthTaken = 0, monthTotal = 0;

      for (let d = new Date(monthStart); d <= monthEnd; d.setDate(d.getDate()+1)) {
        const data = loadData(formatDate(d));
        const dayTaken = medicationTimes.filter(t => data.times[t]).length
                       + data.custom.filter(it => it.taken).length;
        const dayTotal = medicationTimes.length + data.custom.length;
        monthTaken += dayTaken;
        monthTotal += dayTotal;
      }

      document.getElementById('monthlyTakenCount').textContent = monthTaken;
      document.getElementById('monthlyTotalCount').textContent = monthTotal;

      // é€£ç¶šã¯ã€Œä»Šæœˆã®æœ€é•·é€£ç¶šã€ã‚’è¡¨ç¤º
      const monthlyBestStreak = calcMonthlyBestStreak(monthStart, monthEnd);
      document.getElementById('monthlyStreakCount').textContent = monthlyBestStreak;
      document.getElementById('streakLabel').textContent = 'ä»Šæœˆã®æœ€é•·é€£ç¶šæ—¥æ•°';
    }

    function calcMonthlyBestStreak(monthStart, monthEnd){
      let best = 0, run = 0;
      for (let d = new Date(monthStart); d <= monthEnd; d.setDate(d.getDate()+1)) {
        const data = loadData(formatDate(d));
        const totalTimes = medicationTimes.length + data.custom.length;
        const takenTimes = medicationTimes.filter(t => data.times[t]).length
                        + data.custom.filter(it => it.taken).length;
        if (totalTimes > 0 && takenTimes === totalTimes) {
          run++; if (run > best) best = run;
        } else {
          run = 0;
        }
      }
      return best;
    }

    // å¿…è¦ãªã‚‰ã€Œä»Šã®é€£ç¶šã€ï¼ˆä»Šæ—¥ã‹ã‚‰ã®ç¶™ç¶šï¼‰ã‚‚è¨ˆç®—ã§ãã‚‹
    function calcCurrentStreak(){
      let streak = 0;
      const today = new Date(); today.setHours(0,0,0,0);
      for (let i=0;i<400;i++){
        const d = new Date(today); d.setDate(today.getDate()-i);
        const data = loadData(formatDate(d));
        const totalTimes = medicationTimes.length + data.custom.length;
        const takenTimes = medicationTimes.filter(t => data.times[t]).length
                        + data.custom.filter(it => it.taken).length;
        if (totalTimes > 0 && takenTimes === totalTimes) streak++;
        else break;
      }
      return streak;
    }

    // åˆæœŸåŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateMonthlyStatistics);
    } else {
      updateMonthlyStatistics();
    }
  </script>
</body>
</html>
