<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’Š æœè–¬ç®¡ç†ã‚¢ãƒ—ãƒª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Zen+Maru+Gothic&display=swap" rel="stylesheet">
  <style>
    /* ===== RESET & BASE ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100vw;
      min-height: 100vh;
      font-size: 18px;
      font-family: 'M PLUS Rounded 1c', sans-serif;
      line-height: 1.6;
      overflow-x: hidden;
      transition: all 0.8s ease;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      position: relative;
    }

    /* ===== THEME VARIATIONS ===== */
    body.morning {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    }
    body.noon {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }
    body.evening {
      background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
    }
    body.night {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: #ecf0f1;
    }

    /* ===== MAIN CONTAINER ===== */
    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 2;
    }

    /* ===== HEADER ===== */
    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .status-display {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 15px;
    }

    .status-item {
      flex: 1;
      min-width: 150px;
      text-align: center;
    }

    .date-time {
      font-weight: bold;
      font-size: 1.1rem;
    }

    /* ===== PROGRESS BAR ===== */
    .progress-section {
      margin: 25px 0;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22c55e);
      border-radius: 10px;
      transition: width 0.5s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        transparent 25%, rgba(255,255,255,0.2) 25%, 
        rgba(255,255,255,0.2) 50%, transparent 50%, 
        transparent 75%, rgba(255,255,255,0.2) 75%);
      background-size: 20px 20px;
      animation: progress-animation 1s linear infinite;
    }

    @keyframes progress-animation {
      0% { background-position: 0 0; }
      100% { background-position: 20px 0; }
    }

    /* ===== NAVIGATION ===== */
    nav {
      margin: 25px 0;
    }

    .nav-buttons, .time-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 15px 0;
    }

    /* ===== BUTTONS ===== */
    button {
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      min-width: 80px;
    }

    button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    button:hover:before {
      left: 100%;
    }

    button:active {
      transform: scale(0.95);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(74, 222, 128, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(248, 113, 113, 0.3);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: inherit;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .time-button.taken {
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 222, 128, 0.4);
    }

    .time-button.not-taken {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      color: white;
    }

    /* ===== CUSTOM TIME FORM ===== */
    .add-time-section {
      margin: 25px 0;
      text-align: center;
    }

    .time-form {
      display: none;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      margin-top: 15px;
    }

    .time-form input {
      padding: 12px 15px;
      font-size: 1rem;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: inherit;
      backdrop-filter: blur(10px);
      margin-right: 10px;
      min-width: 200px;
    }

    .time-form input::placeholder {
      color: rgba(255,255,255,0.6);
    }

    /* ===== CUSTOM TIMES ===== */
    .custom-times {
      margin: 20px 0;
    }

    .custom-time-item {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 8px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 5px;
      border-radius: 12px;
    }

    .delete-btn {
      background: rgba(239, 68, 68, 0.8);
      color: white;
      font-size: 0.8rem;
      padding: 6px 10px;
      min-width: auto;
    }

    /* ===== RECORDS TABLE ===== */
    .records-section {
      margin: 30px 0;
    }

    .week-nav {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .week-range {
      text-align: center;
      font-weight: bold;
      margin: 10px 0;
      font-size: 1.1rem;
    }

    .table-container {
      overflow-x: auto;
      background: rgba(255,255,255,0.9);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
    }

    .records-table th,
    .records-table td {
      border: 2px solid #e5e7eb;
      padding: 12px;
      text-align: center;
      color: #374151;
      font-weight: 600;
    }

    .records-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .records-table .circle {
      color: #059669;
      font-size: 1.2rem;
    }

    .records-table .cross {
      color: #dc2626;
      font-size: 1.2rem;
    }

    /* ===== NOTIFICATIONS ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 15px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      max-width: 300px;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      border-left: 4px solid #22c55e;
      color: #065f46;
    }

    .notification.error {
      border-left: 4px solid #ef4444;
      color: #7f1d1d;
    }

    /* ===== FLOATING EMOJIS ===== */
    .floating-emoji {
      position: fixed;
      top: -50px;
      z-index: 1;
      pointer-events: none;
      user-select: none;
      font-size: 28px;
      opacity: 0.8;
      animation: float-down 4s linear forwards;
    }

    @keyframes float-down {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 0.8;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* ===== STATS SECTION ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 25px 0;
    }

    .stat-card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      opacity: 0.8;
      font-size: 0.9rem;
    }

    /* ===== BACKUP SECTION ===== */
    .backup-section {
      margin: 30px 0;
      padding: 20px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
    }

    .backup-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      html, body {
        font-size: 16px;
      }

      .status-display {
        flex-direction: column;
        gap: 10px;
      }

      .nav-buttons, .time-buttons {
        gap: 8px;
      }

      button {
        padding: 10px 15px;
        font-size: 0.9rem;
      }

      .records-table th,
      .records-table td {
        padding: 8px;
        font-size: 0.9rem;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-number {
        font-size: 1.5rem;
      }
    }

    /* ===== ACCESSIBILITY ===== */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    button:focus,
    input:focus {
      outline: 3px solid #fbbf24;
      outline-offset: 2px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header>
      <h1>ğŸ’Š æœè–¬ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
      <div class="status-display">
        <div class="status-item">
          <div class="date-time" id="dateDisplay" aria-live="polite"></div>
          <div>ä»Šæ—¥ã®æ—¥ä»˜</div>
        </div>
        <div class="status-item">
          <div class="date-time" id="timeDisplay" aria-live="polite"></div>
          <div>ç¾åœ¨æ™‚åˆ»</div>
        </div>
        <div class="status-item">
          <div class="date-time" id="streakDisplay">0æ—¥</div>
          <div>é€£ç¶šæœè–¬</div>
        </div>
      </div>
    </header>

    <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
    <section class="progress-section" aria-labelledby="progress-title">
      <div class="progress-header">
        <h2 id="progress-title">ä»Šæ—¥ã®é€²æ—</h2>
        <span id="progressText" aria-live="polite">0%</span>
      </div>
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </section>

    <!-- çµ±è¨ˆ -->
    <section class="stats-grid" aria-labelledby="stats-title">
      <h2 id="stats-title" class="sr-only">çµ±è¨ˆæƒ…å ±</h2>
      <div class="stat-card">
        <div class="stat-number" id="todayCount">0/0</div>
        <div class="stat-label">ä»Šæ—¥ã®æœè–¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="weekCount">0/0</div>
        <div class="stat-label">ä»Šé€±ã®æœè–¬</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="monthCount">0/0</div>
        <div class="stat-label">ä»Šæœˆã®æœè–¬</div>
      </div>
    </section>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav aria-label="ã‚¢ãƒ—ãƒªãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
      <div class="nav-buttons">
        <button type="button" class="btn-primary" onclick="showMonthlyView()" aria-label="æœˆé–“çµ±è¨ˆã‚’è¡¨ç¤º">
          ğŸ“ˆ æœˆé–“çµ±è¨ˆ
        </button>
        <button type="button" class="btn-secondary" onclick="exportData()" aria-label="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
          ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        </button>
        <button type="button" class="btn-secondary" onclick="importData()" aria-label="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">
          ğŸ“ ãƒ‡ãƒ¼ã‚¿èª­è¾¼
        </button>
      </div>
    </nav>

    <!-- æœè–¬ãƒœã‚¿ãƒ³ -->
    <main>
      <section aria-labelledby="medication-title">
        <h2 id="medication-title" class="sr-only">æœè–¬ãƒã‚§ãƒƒã‚¯</h2>
        <div class="time-buttons" id="timeButtons" role="group" aria-label="æœè–¬æ™‚é–“"></div>
        <div class="custom-times" id="customTimes"></div>
      </section>

      <!-- ä»»æ„æ™‚é–“è¿½åŠ  -->
      <section class="add-time-section" aria-labelledby="add-time-title">
        <h3 id="add-time-title" class="sr-only">ä»»æ„æ™‚é–“è¿½åŠ </h3>
        <button type="button" class="btn-primary" onclick="toggleAddForm()" aria-label="ä»»æ„ã®æœè–¬æ™‚é–“ã‚’è¿½åŠ ">
          ï¼‹ ä»»æ„æ™‚é–“ã‚’è¿½åŠ 
        </button>
        <div class="time-form" id="addTimeForm">
          <label for="newTimeInput" class="sr-only">æ–°ã—ã„æœè–¬æ™‚é–“ã®åå‰</label>
          <input type="text" id="newTimeInput" placeholder="ä¾‹ï¼šå°±å¯å‰ã€é£Ÿå¾Œãªã©" maxlength="20">
          <button type="button" class="btn-success" onclick="addCustomTime()" aria-label="æ™‚é–“ã‚’è¿½åŠ ã™ã‚‹">
            è¿½åŠ 
          </button>
          <button type="button" class="btn-secondary" onclick="toggleAddForm()" aria-label="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
      </section>
    </main>

    <!-- è¨˜éŒ²ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <section class="records-section" aria-labelledby="records-title">
      <h2 id="records-title" class="sr-only">é€±é–“è¨˜éŒ²</h2>
      <div class="week-nav">
        <div class="nav-buttons">
          <button type="button" class="btn-secondary" onclick="changeWeek(-1)" aria-label="å‰ã®é€±">
            â† å‰ã®é€±
          </button>
          <button type="button" class="btn-primary" onclick="goToCurrentWeek()" aria-label="ä»Šé€±ã«æˆ»ã‚‹">
            ä»Šé€±
          </button>
          <button type="button" class="btn-secondary" onclick="changeWeek(1)" aria-label="æ¬¡ã®é€±">
            æ¬¡ã®é€± â†’
          </button>
        </div>
        <div class="week-range" id="weekRange" aria-live="polite"></div>
      </div>
      <div class="table-container">
        <table class="records-table" id="recordsTable" aria-label="é€±é–“æœè–¬è¨˜éŒ²">
          <thead>
            <tr>
              <th scope="col">æ™‚é–“ï¼¼æ›œæ—¥</th>
              <th scope="col">æ—¥</th>
              <th scope="col">æœˆ</th>
              <th scope="col">ç«</th>
              <th scope="col">æ°´</th>
              <th scope="col">æœ¨</th>
              <th scope="col">é‡‘</th>
              <th scope="col">åœŸ</th>
            </tr>
          </thead>
          <tbody id="recordsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— -->
    <section class="backup-section" aria-labelledby="backup-title">
      <h3 id="backup-title">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
      <p>æœè–¬ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„å¾©å…ƒãŒã§ãã¾ã™</p>
      <div class="backup-buttons">
        <button type="button" class="btn-success" onclick="downloadBackup()" aria-label="ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
          â¬‡ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
        <button type="button" class="btn-primary" onclick="uploadBackup()" aria-label="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰">
          â¬†ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        </button>
        <button type="button" class="btn-danger" onclick="clearAllData()" aria-label="å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">
          ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        </button>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileUpload(event)">
    </section>
  </div>

  <script>
    // ===== GLOBAL VARIABLES =====
    let currentWeekStart = null;
    let currentDate = new Date();
    let medicationTimes = ['æœ', 'æ˜¼', 'æ™©'];
    let customTimes = [];

    // ===== UTILITY FUNCTIONS =====
    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function formatJapaneseDate(date) {
      return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    }

    function getWeekday(date) {
      return 'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[date.getDay()];
    }

    function getWeekStart(date) {
      const d = new Date(date);
      d.setDate(d.getDate() - d.getDay());
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getDatesOfWeek(startDate) {
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        dates.push(date);
      }
      return dates;
    }

    // ===== DATA MANAGEMENT =====
    function saveData(dateStr, data) {
      try {
        localStorage.setItem(`medication-${dateStr}`, JSON.stringify(data));
        showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showNotification('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    function loadData(dateStr) {
      try {
        const json = localStorage.getItem(`medication-${dateStr}`);
        return json ? JSON.parse(json) : { times: {}, custom: [] };
      } catch (error) {
        console.error('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        return { times: {}, custom: [] };
      }
    }

    function getAllData() {
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('medication-')) {
          const dateStr = key.replace('medication-', '');
          data[dateStr] = loadData(dateStr);
        }
      }
      return data;
    }

    // ===== NOTIFICATION SYSTEM =====
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 5px;">
          ${type === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ ã‚¨ãƒ©ãƒ¼'}
        </div>
        <div>${message}</div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ===== THEME MANAGEMENT =====
    function updateTheme() {
      const hour = new Date().getHours();
      const body = document.body;
      body.classList.remove('morning', 'noon', 'evening', 'night');

      if (hour >= 6 && hour < 12) {
        body.classList.add('morning');
      } else if (hour >= 12 && hour < 18) {
        body.classList.add('noon');
      } else if (hour >= 18 && hour < 22) {
        body.classList.add('evening');
      } else {
        body.classList.add('night');
      }
    }

    // ===== TIME DISPLAY =====
    function updateTimeDisplay() {
      const now = new Date();
      const dateStr = formatJapaneseDate(now);
      const timeStr = now.toLocaleTimeString('ja-JP', { hour12: false });
      const weekday = getWeekday(now);

      document.getElementById('dateDisplay').textContent = `${dateStr}ï¼ˆ${weekday}ï¼‰`;
      document.getElementById('timeDisplay').textContent = timeStr;
    }

    // ===== MEDICATION BUTTONS =====
    function toggleMedication(timeLabel, isCustom = false) {
      const dateStr = formatDate(currentDate);
      const data = loadData(dateStr);

      if (isCustom) {
        const customItem = data.custom.find(item => item.label === timeLabel);
        if (customItem) {
          customItem.taken = !customItem.taken;
        }
      } else {
        data.times[timeLabel] = !data.times[timeLabel];
      }

      saveData(dateStr, data);
      updateDisplay();
      createFloatingEmoji(data.times[timeLabel] || (isCustom && data.custom.find(item => item.label === timeLabel)?.taken));
    }

    function renderTimeButtons() {
      const container = document.getElementById('timeButtons');
      container.innerHTML = '';

      const dateStr = formatDate(currentDate);
      const data = loadData(dateStr);

      medicationTimes.forEach(time => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = `time-button ${data.times[time] ? 'taken' : 'not-taken'}`;
        button.textContent = time;
        button.setAttribute('aria-label', `${time}ã®æœè–¬ã‚’${data.times[time] ? 'å–ã‚Šæ¶ˆã—' : 'ãƒã‚§ãƒƒã‚¯'}`);
        button.onclick = () => toggleMedication(time);
        container.appendChild(button);
      });
    }

    function renderCustomTimes() {
      const container = document.getElementById('customTimes');
      container.innerHTML = '';

      const dateStr = formatDate(currentDate);
      const data = loadData(dateStr);

      data.custom.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = 'custom-time-item';

        const button = document.createElement('button');
        button.type = 'button';
        button.className = `time-button ${item.taken ? 'taken' : 'not-taken'}`;
        button.textContent = item.label;
        button.setAttribute('aria-label', `${item.label}ã®æœè–¬ã‚’${item.taken ? 'å–ã‚Šæ¶ˆã—' : 'ãƒã‚§ãƒƒã‚¯'}`);
        button.onclick = () => toggleMedication(item.label, true);

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'å‰Šé™¤';
        deleteBtn.setAttribute('aria-label', `${item.label}ã‚’å‰Šé™¤`);
        deleteBtn.onclick = () => deleteCustomTime(item.label);

        wrapper.appendChild(button);
        wrapper.appendChild(deleteBtn);
        container.appendChild(wrapper);
      });
    }

    // ===== CUSTOM TIME MANAGEMENT =====
    function toggleAddForm() {
      const form = document.getElementById('addTimeForm');
      const isVisible = form.style.display === 'block';
      form.style.display = isVisible ? 'none' : 'block';
      
      if (!isVisible) {
        document.getElementById('newTimeInput').focus();
      }
    }

    function addCustomTime() {
      const input = document.getElementById('newTimeInput');
      const label = input.value.trim();
      
      if (!label) {
        showNotification('æ™‚é–“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      const dateStr = formatDate(currentDate);
      const data = loadData(dateStr);
      
      if (data.custom.some(item => item.label === label)) {
        showNotification('åŒã˜åå‰ã®æ™‚é–“ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™', 'error');
        return;
      }

      data.custom.push({ label, taken: false });
      saveData(dateStr, data);
      
      input.value = '';
      toggleAddForm();
      updateDisplay();
      showNotification(`ã€Œ${label}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
    }

    function deleteCustomTime(label) {
      if (!confirm(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

      // å…¨ã¦ã®æ—¥ä»˜ã‹ã‚‰è©²å½“ã®ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ã‚’å‰Šé™¤
      const allData = getAllData();
      Object.keys(allData).forEach(dateStr => {
        const data = allData[dateStr];
        data.custom = data.custom.filter(item => item.label !== label);
        saveData(dateStr, data);
      });

      updateDisplay();
      showNotification(`ã€Œ${label}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
    }

    // ===== PROGRESS & STATISTICS =====
    function updateProgress() {
      const dateStr = formatDate(currentDate);
      const data = loadData(dateStr);
      
      const totalTimes = medicationTimes.length + data.custom.length;
      const takenTimes = medicationTimes.filter(time => data.times[time]).length + 
                        data.custom.filter(item => item.taken).length;
      
      const percentage = totalTimes > 0 ? Math.round((takenTimes / totalTimes) * 100) : 0;
      
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressFill.style.width = `${percentage}%`;
      progressText.textContent = `${percentage}%`;
      
      // ARIAãƒãƒªãƒ¥ãƒ¼ã‚’æ›´æ–°
      const progressBar = progressFill.parentElement;
      progressBar.setAttribute('aria-valuenow', percentage);
      
      return { taken: takenTimes, total: totalTimes, percentage };
    }

    function updateStatistics() {
      const today = updateProgress();
      document.getElementById('todayCount').textContent = `${today.taken}/${today.total}`;

      // ä»Šé€±ã®çµ±è¨ˆ
      const weekDates = getDatesOfWeek(getWeekStart(currentDate));
      let weekTaken = 0, weekTotal = 0;
      
      weekDates.forEach(date => {
        const dateStr = formatDate(date);
        const data = loadData(dateStr);
        const dayTaken = medicationTimes.filter(time => data.times[time]).length + 
                        data.custom.filter(item => item.taken).length;
        const dayTotal = medicationTimes.length + data.custom.length;
        
        weekTaken += dayTaken;
        weekTotal += dayTotal;
      });
      
      document.getElementById('weekCount').textContent = `${weekTaken}/${weekTotal}`;

      // ä»Šæœˆã®çµ±è¨ˆ
      const monthStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const monthEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      let monthTaken = 0, monthTotal = 0;
      
      for (let d = new Date(monthStart); d <= monthEnd; d.setDate(d.getDate() + 1)) {
        const dateStr = formatDate(d);
        const data = loadData(dateStr);
        const dayTaken = medicationTimes.filter(time => data.times[time]).length + 
                        data.custom.filter(item => item.taken).length;
        const dayTotal = medicationTimes.length + data.custom.length;
        
        monthTaken += dayTaken;
        monthTotal += dayTotal;
      }
      
      document.getElementById('monthCount').textContent = `${monthTaken}/${monthTotal}`;

      // é€£ç¶šæœè–¬æ—¥æ•°ã‚’è¨ˆç®—
      updateStreak();
    }

    function updateStreak() {
      let streak = 0;
      const today = new Date();
      
      for (let i = 0; i < 365; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - i);
        const dateStr = formatDate(checkDate);
        const data = loadData(dateStr);
        
        const totalTimes = medicationTimes.length + data.custom.length;
        const takenTimes = medicationTimes.filter(time => data.times[time]).length + 
                          data.custom.filter(item => item.taken).length;
        
        if (totalTimes > 0 && takenTimes === totalTimes) {
          streak++;
        } else {
          break;
        }
      }
      
      document.getElementById('streakDisplay').textContent = `${streak}æ—¥`;
    }

    // ===== WEEK NAVIGATION =====
    function changeWeek(direction) {
      if (!currentWeekStart) {
        currentWeekStart = getWeekStart(currentDate);
      }
      
      currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
      updateWeekDisplay();
    }

    function goToCurrentWeek() {
      currentWeekStart = getWeekStart(new Date());
      updateWeekDisplay();
    }

    function updateWeekDisplay() {
      if (!currentWeekStart) {
        currentWeekStart = getWeekStart(currentDate);
      }
      
      const weekDates = getDatesOfWeek(currentWeekStart);
      const start = formatJapaneseDate(weekDates[0]);
      const end = formatJapaneseDate(weekDates[6]);
      
      document.getElementById('weekRange').textContent = `${start} ã€œ ${end}`;
      updateRecordsTable(weekDates);
    }

    // ===== RECORDS TABLE =====
    function updateRecordsTable(weekDates) {
      const tbody = document.getElementById('recordsBody');
      tbody.innerHTML = '';

      // å…¨ã¦ã®æ™‚é–“ãƒ©ãƒ™ãƒ«ã‚’åé›†
      const allTimeLabels = [...medicationTimes];
      const customLabelsSet = new Set();
      
      weekDates.forEach(date => {
        const dateStr = formatDate(date);
        const data = loadData(dateStr);
        data.custom.forEach(item => customLabelsSet.add(item.label));
      });
      
      allTimeLabels.push(...customLabelsSet);

      // å„æ™‚é–“ãƒ©ãƒ™ãƒ«ã«å¯¾ã—ã¦è¡Œã‚’ä½œæˆ
      allTimeLabels.forEach(timeLabel => {
        const row = document.createElement('tr');
        
        const headerCell = document.createElement('th');
        headerCell.scope = 'row';
        headerCell.textContent = timeLabel;
        row.appendChild(headerCell);

        weekDates.forEach(date => {
          const cell = document.createElement('td');
          const dateStr = formatDate(date);
          const data = loadData(dateStr);
          
          let taken = false;
          if (medicationTimes.includes(timeLabel)) {
            taken = data.times[timeLabel];
          } else {
            const customItem = data.custom.find(item => item.label === timeLabel);
            taken = customItem ? customItem.taken : null;
          }
          
          if (taken === true) {
            cell.textContent = 'â—‹';
            cell.className = 'circle';
            cell.setAttribute('aria-label', `${timeLabel} ${formatJapaneseDate(date)} æœè–¬æ¸ˆã¿`);
          } else if (taken === false) {
            cell.textContent = 'Ã—';
            cell.className = 'cross';
            cell.setAttribute('aria-label', `${timeLabel} ${formatJapaneseDate(date)} æœªæœè–¬`);
          } else {
            cell.textContent = '';
            cell.setAttribute('aria-label', `${timeLabel} ${formatJapaneseDate(date)} ãƒ‡ãƒ¼ã‚¿ãªã—`);
          }
          
          row.appendChild(cell);
        });
        
        tbody.appendChild(row);
      });
    }

    // ===== FLOATING ANIMATIONS =====
    function createFloatingEmoji(isSuccess) {
      const emojis = isSuccess ? 
        ['ğŸ‰', 'âœ¨', 'ğŸ’Š', 'ğŸ‘', 'ğŸŒŸ', 'ğŸ’š'] : 
        ['ğŸ˜…', 'ğŸ’­', 'â°', 'ğŸ””'];
      
      const emoji = document.createElement('div');
      emoji.className = 'floating-emoji';
      emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      emoji.style.left = Math.random() * 100 + 'vw';
      emoji.style.animationDuration = (3 + Math.random() * 2) + 's';
      
      document.body.appendChild(emoji);
      
      setTimeout(() => emoji.remove(), 5000);
    }

    function startRandomEmojiRain() {
      const emojis = ['ğŸ’Š', 'ğŸŒ¸', 'â­', 'ğŸ’™', 'ğŸƒ'];
      
      setInterval(() => {
        if (Math.random() < 0.3) { // 30%ã®ç¢ºç‡ã§çµµæ–‡å­—ã‚’é™ã‚‰ã›ã‚‹
          createFloatingEmoji(true);
        }
      }, 2000);
    }

    // ===== DATA BACKUP =====
    function exportData() {
      try {
        const data = getAllData();
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `medication-backup-${formatDate(new Date())}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        showNotification('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    function importData() {
      const input = document.getElementById('fileInput');
      input.click();
    }

    function downloadBackup() {
      exportData();
    }

    function uploadBackup() {
      importData();
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (confirm('æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
            Object.keys(data).forEach(dateStr => {
              saveData(dateStr, data[dateStr]);
            });
            updateDisplay();
            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
          }
        } catch (error) {
          console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          showNotification('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™', 'error');
        }
      };
      reader.readAsText(file);
    }

    function clearAllData() {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      if (!confirm('æœ€çµ‚ç¢ºèªï¼šæœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('medication-')) {
            keys.push(key);
          }
        }
        
        keys.forEach(key => localStorage.removeItem(key));
        updateDisplay();
        showNotification('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showNotification('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }

    // ===== MAIN UPDATE FUNCTION =====
    function updateDisplay() {
      renderTimeButtons();
      renderCustomTimes();
      updateStatistics();
      updateWeekDisplay();
    }

// ===== MONTHLY VIEW =====
function showMonthlyView() {
  location.href = 'monthly.html'; // åˆ¥ãƒšãƒ¼ã‚¸ã«ç§»å‹•
}

    // ===== INITIALIZATION =====
    function init() {
      updateTheme();
      updateTimeDisplay();
      updateDisplay();
      startRandomEmojiRain();

      // æ™‚åˆ»è¡¨ç¤ºã®å®šæœŸæ›´æ–°
      setInterval(updateTimeDisplay, 1000);
      
      // ãƒ†ãƒ¼ãƒã®å®šæœŸæ›´æ–°ï¼ˆ1æ™‚é–“æ¯ï¼‰
      setInterval(updateTheme, 3600000);

      // ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã®è¿½åŠ 
      document.getElementById('newTimeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          addCustomTime();
        }
      });

      console.log('æœè–¬ç®¡ç†ã‚¢ãƒ—ãƒªãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
    }

    // ===== EVENT LISTENERS =====
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
